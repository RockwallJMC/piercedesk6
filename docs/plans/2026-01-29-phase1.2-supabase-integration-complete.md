# Phase 1.2: Complete Supabase Integration & Multi-Tenancy Testing

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Complete Supabase integration for all CRM entities (leads, opportunities, proposals, dashboard), implement comprehensive multi-tenancy testing, and verify end-to-end data isolation across all workflows.

**Architecture:** React 19 + Supabase client-side SDK, SWR data fetching with optimistic updates, Row Level Security (RLS) for multi-tenant isolation, comprehensive E2E testing with Playwright across all CRM workflows.

**Tech Stack:**
- Supabase JavaScript client (`@supabase/supabase-js`)
- SWR for data fetching and cache management
- Playwright for E2E testing
- Supabase RLS policies (already deployed in Phase 1.1)
- React Hook Form + Yup validation

**Current Status:**
- ✅ Phase 1.1: Database schema complete with RLS policies
- ✅ Accounts & Contacts: Already migrated to Supabase (Phase 1.3)
- ⏳ Leads: 14 TODO markers in `useLeadApi.js`
- ⏳ Opportunities: 18 TODO markers in `useOpportunitiesApi.js`
- ⏳ Proposals: ~15 TODO markers in `useProposalApi.js`
- ⏳ Dashboard: ~25 TODO markers in `useDashboardApi.js`
- ⏳ Multi-tenancy tests: 31 tests marked `.skip()` across all feature E2E suites

---

## Task 1: Leads API - Supabase Integration

**Files:**
- Modify: `src/services/swr/api-hooks/useLeadApi.js:1-450`
- Reference: `src/services/swr/api-hooks/useAccountApi.js` (completed pattern)
- Test: Verify with existing tests in `tests/crm-leads.spec.js`

### Step 1: Review existing Supabase pattern

Review the completed accounts API to understand the pattern:

```bash
cat src/services/swr/api-hooks/useAccountApi.js | head -100
```

**Expected:** See pattern with `createClient()`, `getUser()`, RLS-filtered queries, error handling

### Step 2: Migrate useLeads hook (list query)

Replace TODO markers in `useLeads` function at line ~14-33:

```javascript
/**
 * Hook to fetch all leads for the current organization
 * Leads are automatically filtered by organization_id via Row Level Security
 */
export const useLeads = (config) => {
  const fetcher = async () => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    const { data, error } = await supabase
      .from('leads')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      throw new Error(error.message);
    }

    return data || [];
  };

  return useSWR('leads', fetcher, {
    suspense: false,
    revalidateOnMount: true,
    revalidateOnFocus: false,
    ...config,
  });
};
```

### Step 3: Test useLeads hook

Run E2E tests to verify list query works:

```bash
npx playwright test tests/crm-leads.spec.js --grep "should display all leads"
```

**Expected:** Test passes, leads list loads with RLS filtering by organization

### Step 4: Migrate useLead hook (single query)

Replace TODO markers in `useLead` function at line ~84-109:

```javascript
/**
 * Hook to fetch a single lead by ID
 */
export const useLead = (id, config) => {
  const fetcher = async (leadId) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    const { data, error } = await supabase
      .from('leads')
      .select('*')
      .eq('id', leadId)
      .single();

    if (error) {
      throw new Error(error.message);
    }

    return data;
  };

  return useSWR(id ? ['lead', id] : null, () => fetcher(id), {
    suspense: false,
    revalidateOnMount: true,
    revalidateOnFocus: false,
    ...config,
  });
};
```

### Step 5: Migrate useCreateLead mutation

Replace TODO markers at line ~150-176:

```javascript
/**
 * Hook to create a new lead
 */
export const useCreateLead = () => {
  const mutationFn = async (url, { arg: leadData }) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    // organization_id will be set automatically by RLS trigger
    const { data, error } = await supabase
      .from('leads')
      .insert([leadData])
      .select()
      .single();

    if (error) {
      throw new Error(error.message);
    }

    return data;
  };

  return useSWRMutation('leads', mutationFn, {
    revalidate: true,
    populateCache: (created, currentData) => {
      return [created, ...(currentData || [])];
    },
  });
};
```

### Step 6: Test lead creation

Run E2E tests:

```bash
npx playwright test tests/crm-leads.spec.js --grep "should create a new lead"
```

**Expected:** Test passes, new lead created with organization_id set by RLS

### Step 7: Migrate useUpdateLead mutation

Replace TODO markers at line ~226-256:

```javascript
/**
 * Hook to update an existing lead
 */
export const useUpdateLead = () => {
  const mutationFn = async (url, { arg: { id, updates } }) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    const { data, error } = await supabase
      .from('leads')
      .update(updates)
      .eq('id', id)
      .select()
      .single();

    if (error) {
      throw new Error(error.message);
    }

    return data;
  };

  return useSWRMutation('leads', mutationFn, {
    revalidate: false,
    populateCache: (updated, currentData) => {
      if (!Array.isArray(currentData)) return currentData;
      return currentData.map((lead) => (lead.id === updated.id ? updated : lead));
    },
  });
};
```

### Step 8: Migrate useDeleteLead mutation

Replace TODO markers at line ~300-329:

```javascript
/**
 * Hook to delete a lead
 */
export const useDeleteLead = () => {
  const mutationFn = async (url, { arg: id }) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    const { error } = await supabase.from('leads').delete().eq('id', id);

    if (error) {
      throw new Error(error.message);
    }

    return { id };
  };

  return useSWRMutation('leads', mutationFn, {
    revalidate: false,
    populateCache: (deleted, currentData) => {
      if (!Array.isArray(currentData)) return currentData;
      return currentData.filter((lead) => lead.id !== deleted.id);
    },
  });
};
```

### Step 9: Migrate useConvertLeadToOpportunity mutation

Replace TODO markers at line ~370-410 with Supabase transaction:

```javascript
/**
 * Hook to convert a lead to an opportunity
 * Creates account, contact, and opportunity, then marks lead as converted
 */
export const useConvertLeadToOpportunity = () => {
  const mutationFn = async (url, { arg: conversionData }) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    const { leadId, accountData, contactData, opportunityData } = conversionData;

    // Step 1: Create or find account
    let accountId;
    if (accountData.id) {
      accountId = accountData.id;
    } else {
      const { data: newAccount, error: accountError } = await supabase
        .from('accounts')
        .insert([accountData])
        .select()
        .single();

      if (accountError) throw new Error(accountError.message);
      accountId = newAccount.id;
    }

    // Step 2: Create contact
    const { data: newContact, error: contactError } = await supabase
      .from('contacts')
      .insert([{ ...contactData, account_id: accountId }])
      .select()
      .single();

    if (contactError) throw new Error(contactError.message);

    // Step 3: Create opportunity
    const { data: newOpportunity, error: oppError } = await supabase
      .from('opportunities')
      .insert([
        {
          ...opportunityData,
          account_id: accountId,
          primary_contact_id: newContact.id,
        },
      ])
      .select()
      .single();

    if (oppError) throw new Error(oppError.message);

    // Step 4: Mark lead as converted
    const { error: leadError } = await supabase
      .from('leads')
      .update({
        status: 'converted',
        converted_to_opportunity_id: newOpportunity.id,
      })
      .eq('id', leadId);

    if (leadError) throw new Error(leadError.message);

    return {
      account: { id: accountId },
      contact: newContact,
      opportunity: newOpportunity,
    };
  };

  return useSWRMutation('leads/convert', mutationFn, {
    revalidate: true,
  });
};
```

### Step 10: Test lead conversion flow

Run E2E test for conversion:

```bash
npx playwright test tests/crm-leads.spec.js --grep "should convert lead to opportunity"
```

**Expected:** Test passes, lead converted with account/contact/opportunity created

### Step 11: Remove mock data import

Remove or comment out line ~7:

```javascript
// TODO: Replaced with Supabase - removed mock import
// import { leads as mockLeads } from 'data/crm/leads';
```

### Step 12: Run full leads test suite

```bash
npx playwright test tests/crm-leads.spec.js
```

**Expected:** All active tests pass (29 tests), 6 multi-tenancy tests still marked `.skip()`

### Step 13: Commit leads API migration

```bash
git add src/services/swr/api-hooks/useLeadApi.js
git commit -m "feat(crm): migrate leads API to Supabase

- Replace 14 TODO markers with Supabase queries
- Implement lead CRUD operations with RLS
- Add lead-to-opportunity conversion transaction
- All 29 active E2E tests passing

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 2: Opportunities API - Supabase Integration

**Files:**
- Modify: `src/services/swr/api-hooks/useOpportunitiesApi.js:1-500`
- Test: Verify with `tests/crm-opportunities.spec.js`

### Step 1: Migrate useOpportunities hook

Replace TODO markers at line ~14-33:

```javascript
export const useOpportunities = (config) => {
  const fetcher = async () => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    // Query with joined account and contact data
    const { data, error } = await supabase
      .from('opportunities')
      .select(`
        *,
        account:accounts(id, name, industry),
        primary_contact:contacts(id, first_name, last_name, email)
      `)
      .order('created_at', { ascending: false});

    if (error) {
      throw new Error(error.message);
    }

    return data || [];
  };

  return useSWR('opportunities', fetcher, {
    suspense: false,
    revalidateOnMount: true,
    revalidateOnFocus: false,
    ...config,
  });
};
```

### Step 2: Test opportunities list

```bash
npx playwright test tests/crm-opportunities.spec.js --grep "should display opportunities"
```

**Expected:** Opportunities load with account and contact names joined

### Step 3: Migrate useOpportunity hook

Replace TODO markers at line ~135-160:

```javascript
export const useOpportunity = (id, config) => {
  const fetcher = async (oppId) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    const { data, error } = await supabase
      .from('opportunities')
      .select(`
        *,
        account:accounts(*),
        primary_contact:contacts(*),
        proposals:proposals(*)
      `)
      .eq('id', oppId)
      .single();

    if (error) {
      throw new Error(error.message);
    }

    return data;
  };

  return useSWR(id ? ['opportunity', id] : null, () => fetcher(id), {
    suspense: false,
    revalidateOnMount: true,
    revalidateOnFocus: false,
    ...config,
  });
};
```

### Step 4: Migrate useCreateOpportunity mutation

Replace TODO markers at line ~212-239:

```javascript
export const useCreateOpportunity = () => {
  const mutationFn = async (url, { arg: opportunityData }) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    // Set default probability based on stage if not provided
    const stageDefaults = {
      prospecting: 10,
      qualification: 25,
      proposal: 50,
      negotiation: 75,
      closed_won: 100,
      closed_lost: 0,
    };

    const dataWithDefaults = {
      ...opportunityData,
      probability: opportunityData.probability ?? stageDefaults[opportunityData.stage] ?? 25,
    };

    const { data, error } = await supabase
      .from('opportunities')
      .insert([dataWithDefaults])
      .select(`
        *,
        account:accounts(id, name),
        primary_contact:contacts(id, first_name, last_name)
      `)
      .single();

    if (error) {
      throw new Error(error.message);
    }

    return data;
  };

  return useSWRMutation('opportunities', mutationFn, {
    revalidate: true,
    populateCache: (created, currentData) => {
      return [created, ...(currentData || [])];
    },
  });
};
```

### Step 5: Migrate useUpdateOpportunity mutation

Replace TODO markers at line ~292-322:

```javascript
export const useUpdateOpportunity = () => {
  const mutationFn = async (url, { arg: { id, updates } }) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    // Update probability if stage changed and probability not explicitly set
    const stageDefaults = {
      prospecting: 10,
      qualification: 25,
      proposal: 50,
      negotiation: 75,
      closed_won: 100,
      closed_lost: 0,
    };

    const finalUpdates = { ...updates };
    if (updates.stage && !updates.probability) {
      finalUpdates.probability = stageDefaults[updates.stage];
    }

    const { data, error } = await supabase
      .from('opportunities')
      .update(finalUpdates)
      .eq('id', id)
      .select(`
        *,
        account:accounts(id, name),
        primary_contact:contacts(id, first_name, last_name)
      `)
      .single();

    if (error) {
      throw new Error(error.message);
    }

    return data;
  };

  return useSWRMutation('opportunities', mutationFn, {
    revalidate: false,
    populateCache: (updated, currentData) => {
      if (!Array.isArray(currentData)) return currentData;
      return currentData.map((opp) => (opp.id === updated.id ? updated : opp));
    },
  });
};
```

### Step 6: Migrate useDeleteOpportunity mutation

Replace TODO markers at line ~378-407:

```javascript
export const useDeleteOpportunity = () => {
  const mutationFn = async (url, { arg: id }) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    const { error } = await supabase.from('opportunities').delete().eq('id', id);

    if (error) {
      throw new Error(error.message);
    }

    return { id };
  };

  return useSWRMutation('opportunities', mutationFn, {
    revalidate: false,
    populateCache: (deleted, currentData) => {
      if (!Array.isArray(currentData)) return currentData;
      return currentData.filter((opp) => opp.id !== deleted.id);
    },
  });
};
```

### Step 7: Migrate useCalculateWeightedForecast hook

Replace TODO markers at line ~443-467 with Supabase RPC or aggregate query:

```javascript
export const useCalculateWeightedForecast = (config) => {
  const fetcher = async () => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    // Fetch open opportunities (not closed_won or closed_lost)
    const { data, error } = await supabase
      .from('opportunities')
      .select('value, probability, stage')
      .in('stage', ['prospecting', 'qualification', 'proposal', 'negotiation']);

    if (error) {
      throw new Error(error.message);
    }

    // Calculate weighted forecast client-side
    const forecast = (data || []).reduce((sum, opp) => {
      return sum + opp.value * (opp.probability / 100);
    }, 0);

    return { weighted_forecast: forecast };
  };

  return useSWR('opportunities/forecast', fetcher, {
    suspense: false,
    revalidateOnMount: true,
    revalidateOnFocus: false,
    ...config,
  });
};
```

### Step 8: Remove mock data import

Remove line ~7:

```javascript
// import { opportunities as mockOpportunities } from 'data/crm/opportunities';
```

### Step 9: Run opportunities test suite

```bash
npx playwright test tests/crm-opportunities.spec.js
```

**Expected:** All active tests pass (30 tests), 8 multi-tenancy tests still `.skip()`

### Step 10: Commit opportunities API migration

```bash
git add src/services/swr/api-hooks/useOpportunitiesApi.js
git commit -m "feat(crm): migrate opportunities API to Supabase

- Replace 18 TODO markers with Supabase queries
- Implement opportunity CRUD with joined account/contact data
- Add weighted forecast calculation
- Auto-set probability based on stage changes
- All 30 active E2E tests passing

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 3: Proposals API - Supabase Integration

**Files:**
- Modify: `src/services/swr/api-hooks/useProposalApi.js:1-600`
- Modify: `src/utils/crm/proposalNumberGenerator.js:1-50`
- Test: Verify with `tests/crm-proposals.spec.js`

### Step 1: Migrate useProposals hook

Replace TODO markers at line ~22-50:

```javascript
export const useProposals = (config) => {
  const fetcher = async () => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    const { data, error } = await supabase
      .from('proposals')
      .select(`
        *,
        opportunity:opportunities(
          id,
          name,
          value,
          stage,
          account:accounts(id, name)
        ),
        line_items:proposal_line_items(*)
      `)
      .order('created_at', { ascending: false });

    if (error) {
      throw new Error(error.message);
    }

    return data || [];
  };

  return useSWR('proposals', fetcher, {
    suspense: false,
    revalidateOnMount: true,
    revalidateOnFocus: false,
    ...config,
  });
};
```

### Step 2: Migrate useProposal hook

Replace TODO markers at line ~129-154:

```javascript
export const useProposal = (id, config) => {
  const fetcher = async (proposalId) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    const { data, error } = await supabase
      .from('proposals')
      .select(`
        *,
        opportunity:opportunities(
          *,
          account:accounts(*),
          primary_contact:contacts(*)
        ),
        line_items:proposal_line_items(*)
      `)
      .eq('id', proposalId)
      .single();

    if (error) {
      throw new Error(error.message);
    }

    return data;
  };

  return useSWR(id ? ['proposal', id] : null, () => fetcher(id), {
    suspense: false,
    revalidateOnMount: true,
    revalidateOnFocus: false,
    ...config,
  });
};
```

### Step 3: Create proposal number generator with Supabase query

Replace entire file:

**File:** `src/utils/crm/proposalNumberGenerator.js`

```javascript
import createClient from 'lib/supabase/client';

/**
 * Generate the next proposal number for the current year
 * Format: PROP-YYYY-NNNN (e.g., PROP-2026-0001)
 *
 * Queries database for maximum proposal number in current year,
 * increments sequence, and returns formatted proposal number.
 *
 * @returns {Promise<string>} The next proposal number
 */
export async function generateProposalNumber() {
  const supabase = createClient();
  const currentYear = new Date().getFullYear();
  const yearStart = `${currentYear}-01-01T00:00:00Z`;
  const yearEnd = `${currentYear}-12-31T23:59:59Z`;

  // Query max proposal number for current year
  const { data, error } = await supabase
    .from('proposals')
    .select('proposal_number')
    .gte('created_at', yearStart)
    .lte('created_at', yearEnd)
    .order('proposal_number', { ascending: false })
    .limit(1);

  if (error) {
    console.error('Error fetching max proposal number:', error);
    // Fallback to first number for the year
    return `PROP-${currentYear}-0001`;
  }

  // Extract sequence number from last proposal
  let nextSequence = 1;
  if (data && data.length > 0) {
    const lastNumber = data[0].proposal_number;
    const match = lastNumber.match(/PROP-\d{4}-(\d{4})/);
    if (match) {
      nextSequence = parseInt(match[1], 10) + 1;
    }
  }

  // Format with leading zeros (4 digits)
  const sequence = nextSequence.toString().padStart(4, '0');
  return `PROP-${currentYear}-${sequence}`;
}
```

### Step 4: Migrate useCreateProposal mutation

Replace TODO markers at line ~200-227:

```javascript
export const useCreateProposal = () => {
  const mutationFn = async (url, { arg: proposalData }) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    // Generate proposal number
    const proposalNumber = await generateProposalNumber();

    const { data, error } = await supabase
      .from('proposals')
      .insert([{ ...proposalData, proposal_number: proposalNumber }])
      .select(`
        *,
        opportunity:opportunities(id, name, account:accounts(id, name))
      `)
      .single();

    if (error) {
      throw new Error(error.message);
    }

    return data;
  };

  return useSWRMutation('proposals', mutationFn, {
    revalidate: true,
    populateCache: (created, currentData) => {
      return [created, ...(currentData || [])];
    },
  });
};
```

### Step 5: Migrate useUpdateProposal mutation

Replace TODO markers at line ~304-334:

```javascript
export const useUpdateProposal = () => {
  const mutationFn = async (url, { arg: { id, updates } }) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    const { data, error } = await supabase
      .from('proposals')
      .update(updates)
      .eq('id', id)
      .select(`
        *,
        opportunity:opportunities(id, name)
      `)
      .single();

    if (error) {
      throw new Error(error.message);
    }

    return data;
  };

  return useSWRMutation('proposals', mutationFn, {
    revalidate: false,
    populateCache: (updated, currentData) => {
      if (!Array.isArray(currentData)) return currentData;
      return currentData.map((prop) => (prop.id === updated.id ? updated : prop));
    },
  });
};
```

### Step 6: Migrate useCreateProposalWithLineItems mutation

Replace TODO markers at line ~382-413 with Supabase transaction:

```javascript
export const useCreateProposalWithLineItems = () => {
  const mutationFn = async (url, { arg: { proposalData, lineItems } }) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    // Generate proposal number
    const proposalNumber = await generateProposalNumber();

    // Step 1: Create proposal
    const { data: newProposal, error: proposalError } = await supabase
      .from('proposals')
      .insert([{ ...proposalData, proposal_number: proposalNumber }])
      .select()
      .single();

    if (proposalError) throw new Error(proposalError.message);

    // Step 2: Create line items
    const lineItemsWithProposalId = lineItems.map((item) => ({
      ...item,
      proposal_id: newProposal.id,
    }));

    const { data: newLineItems, error: lineItemsError } = await supabase
      .from('proposal_line_items')
      .insert(lineItemsWithProposalId)
      .select();

    if (lineItemsError) throw new Error(lineItemsError.message);

    return {
      ...newProposal,
      line_items: newLineItems,
    };
  };

  return useSWRMutation('proposals/create-with-items', mutationFn, {
    revalidate: true,
  });
};
```

### Step 7: Migrate useUpdateProposalLineItems mutation

Replace TODO markers at line ~498-528:

```javascript
export const useUpdateProposalLineItems = () => {
  const mutationFn = async (url, { arg: { proposalId, lineItems } }) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    // Delete existing line items for this proposal
    const { error: deleteError } = await supabase
      .from('proposal_line_items')
      .delete()
      .eq('proposal_id', proposalId);

    if (deleteError) throw new Error(deleteError.message);

    // Insert new line items
    const lineItemsWithProposalId = lineItems.map((item) => ({
      ...item,
      proposal_id: proposalId,
    }));

    const { data: newLineItems, error: insertError } = await supabase
      .from('proposal_line_items')
      .insert(lineItemsWithProposalId)
      .select();

    if (insertError) throw new Error(insertError.message);

    return newLineItems;
  };

  return useSWRMutation(['proposals', proposalId, 'line-items'], mutationFn, {
    revalidate: true,
  });
};
```

### Step 8: Migrate useGenerateProposalPDF hook

Replace TODO markers at line ~592-620 (placeholder implementation):

```javascript
export const useGenerateProposalPDF = () => {
  const mutationFn = async (url, { arg: proposalId }) => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    // TODO: Implement React-PDF generation + Supabase Storage upload
    // For now, return placeholder PDF URL
    console.log('PDF generation not yet implemented. Proposal ID:', proposalId);

    // Placeholder: In production, this would:
    // 1. Fetch proposal with all related data
    // 2. Generate PDF using React-PDF
    // 3. Upload to Supabase Storage
    // 4. Update proposal.pdf_url with storage URL
    // 5. Return the PDF URL

    return {
      pdf_url: `/api/proposals/${proposalId}/pdf-placeholder`,
      generated_at: new Date().toISOString(),
    };
  };

  return useSWRMutation(['proposals', 'generate-pdf'], mutationFn);
};
```

### Step 9: Remove mock data import

Remove line ~15:

```javascript
// import { proposals as mockProposals } from 'data/crm/proposals';
```

### Step 10: Run proposals test suite

```bash
npx playwright test tests/crm-proposals.spec.js
```

**Expected:** All active tests pass (35 tests), 6 multi-tenancy tests still `.skip()`

### Step 11: Commit proposals API migration

```bash
git add src/services/swr/api-hooks/useProposalApi.js src/utils/crm/proposalNumberGenerator.js
git commit -m "feat(crm): migrate proposals API to Supabase

- Replace 15 TODO markers with Supabase queries
- Implement proposal CRUD with line items transaction
- Add database-backed proposal number generation
- PDF generation marked TODO for future implementation
- All 35 active E2E tests passing

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 4: Dashboard API - Supabase Integration

**Files:**
- Modify: `src/services/swr/api-hooks/useDashboardApi.js:1-300`
- Test: Verify with `tests/crm-dashboard.spec.js`

### Step 1: Migrate usePipelineMetrics hook

Replace TODO markers at line ~25-60 with Supabase aggregate query:

```javascript
export const usePipelineMetrics = (config) => {
  const fetcher = async () => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    // Aggregate query for open opportunities
    const { data, error } = await supabase
      .from('opportunities')
      .select('value, probability, stage')
      .in('stage', ['prospecting', 'qualification', 'proposal', 'negotiation']);

    if (error) {
      throw new Error(error.message);
    }

    // Calculate metrics client-side
    const totalPipeline = data.reduce((sum, opp) => sum + opp.value, 0);
    const weightedForecast = data.reduce((sum, opp) => sum + opp.value * (opp.probability / 100), 0);
    const opportunityCount = data.length;

    return {
      total_pipeline: totalPipeline,
      weighted_forecast: weightedForecast,
      opportunity_count: opportunityCount,
    };
  };

  return useSWR('dashboard/pipeline-metrics', fetcher, {
    suspense: false,
    revalidateOnMount: true,
    revalidateOnFocus: false,
    refreshInterval: 30000, // Refresh every 30 seconds
    ...config,
  });
};
```

### Step 2: Migrate useConversionMetrics hook

Replace TODO markers at line ~51-90:

```javascript
export const useConversionMetrics = (config) => {
  const fetcher = async () => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    // Fetch counts for conversion funnel using count aggregates
    const [
      { count: totalLeads },
      { count: qualifiedCount },
      { count: opportunityCount },
      { count: wonCount },
    ] = await Promise.all([
      supabase.from('leads').select('*', { count: 'exact', head: true }),
      supabase
        .from('leads')
        .select('*', { count: 'exact', head: true })
        .in('status', ['qualified', 'converted']),
      supabase.from('opportunities').select('*', { count: 'exact', head: true }),
      supabase
        .from('opportunities')
        .select('*', { count: 'exact', head: true })
        .eq('stage', 'closed_won'),
    ]);

    return {
      lead_to_opportunity_rate:
        totalLeads > 0 ? (opportunityCount / totalLeads) * 100 : 0,
      opportunity_to_won_rate:
        opportunityCount > 0 ? (wonCount / opportunityCount) * 100 : 0,
      overall_conversion_rate: totalLeads > 0 ? (wonCount / totalLeads) * 100 : 0,
    };
  };

  return useSWR('dashboard/conversion-metrics', fetcher, {
    suspense: false,
    revalidateOnMount: true,
    revalidateOnFocus: false,
    refreshInterval: 60000, // Refresh every minute
    ...config,
  });
};
```

### Step 3: Migrate usePipelineTrend hook

Replace TODO markers at line ~85-120 with time-series query:

```javascript
export const usePipelineTrend = (days = 30, config) => {
  const fetcher = async () => {
    const supabase = createClient();
    const {
      data: { user },
      error: authError,
    } = await supabase.auth.getUser();

    if (authError || !user) {
      throw new Error(authError?.message || 'Not authenticated');
    }

    const startDate = new Date();
    startDate.setDate(startDate.getDate() - days);

    const { data, error } = await supabase
      .from('opportunities')
      .select('created_at, value, probability')
      .gte('created_at', startDate.toISOString())
      .order('created_at', { ascending: true });

    if (error) {
      throw new Error(error.message);
    }

    // Group by date and calculate daily pipeline value
    const trendData = {};
    data.forEach((opp) => {
      const date = opp.created_at.split('T')[0]; // YYYY-MM-DD
      if (!trendData[date]) {
        trendData[date] = { total_value: 0, weighted_value: 0, count: 0 };
      }
      trendData[date].total_value += opp.value;
      trendData[date].weighted_value += opp.value * (opp.probability / 100);
      trendData[date].count += 1;
    });

    return Object.entries(trendData).map(([date, metrics]) => ({
      date,
      ...metrics,
    }));
  };

  return useSWR(['dashboard/pipeline-trend', days], fetcher, {
    suspense: false,
    revalidateOnMount: true,
    revalidateOnFocus: false,
    refreshInterval: 60000,
    ...config,
  });
};
```

### Step 4: Migrate remaining dashboard hooks (Steps 4-9)

Continue migrating these hooks with similar patterns:
- `useStageBreakdown` (line ~113-148)
- `useRecentActivities` (line ~143-175)
- `useTopOpportunities` (line ~170-206)
- `useLeadSourcePerformance` (line ~201-240)
- `useConversionFunnel` (line ~235-278)
- `useLeadsByStatus` (line ~273-300)

Each follows the same pattern:
1. Create Supabase client
2. Get authenticated user
3. Execute query with RLS filtering
4. Aggregate data client-side if needed
5. Return formatted results

### Step 10: Run dashboard test suite

```bash
npx playwright test tests/crm-dashboard.spec.js
```

**Expected:** All active tests pass, RLS verification test still has TODO comment

### Step 11: Commit dashboard API migration

```bash
git add src/services/swr/api-hooks/useDashboardApi.js
git commit -m "feat(crm): migrate dashboard API to Supabase

- Replace 25 TODO markers with Supabase aggregate queries
- Implement 10 dashboard metric hooks with real-time data
- Add pipeline metrics, conversion funnel, stage breakdown
- Client-side aggregation for complex metrics
- All active E2E tests passing

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 5: Multi-Tenancy E2E Testing (CRITICAL)

**Overview:** Enable and verify all 31 multi-tenancy tests across CRM features to ensure complete data isolation.

**Files:**
- Modify: `tests/crm-leads-multi-tenancy.spec.js` (6 tests)
- Modify: `tests/crm-opportunities-multi-tenancy.spec.js` (8 tests)
- Modify: `tests/crm-proposals-multi-tenancy.spec.js` (6 tests)
- Modify: `tests/crm-accounts-contacts-multi-tenancy.spec.js` (12 tests)
- Create: `tests/helpers/multi-tenant-setup.js` (test utilities)

### Step 1: Create multi-tenant test helper utilities

**File:** `tests/helpers/multi-tenant-setup.js`

```javascript
/**
 * Multi-tenant test utilities for Supabase RLS verification
 */

/**
 * Create two test organizations with different users
 * @param {Page} page - Playwright page
 * @returns {Promise<Object>} Organization details
 */
export async function setupTwoOrganizations(page) {
  // Organization Alpha setup
  await page.goto('/auth/login');
  await page.fill('[name="email"]', 'alpha@piercedesk.test');
  await page.fill('[name="password"]', 'TestPassword123!');
  await page.click('button[type="submit"]');

  await page.waitForURL('/organization-setup');
  await page.fill('[name="organization_name"]', 'Organization Alpha');
  await page.click('button:has-text("Create Organization")');
  await page.waitForURL('/apps/crm/dashboard');

  const alphaOrgId = await page.evaluate(() => {
    return window.localStorage.getItem('current_organization_id');
  });

  await page.click('[aria-label="Sign out"]');

  // Organization Beta setup
  await page.goto('/auth/login');
  await page.fill('[name="email"]', 'beta@piercedesk.test');
  await page.fill('[name="password"]', 'TestPassword123!');
  await page.click('button[type="submit"]');

  await page.waitForURL('/organization-setup');
  await page.fill('[name="organization_name"]', 'Organization Beta');
  await page.click('button:has-text("Create Organization")');
  await page.waitForURL('/apps/crm/dashboard');

  const betaOrgId = await page.evaluate(() => {
    return window.localStorage.getItem('current_organization_id');
  });

  return {
    alpha: {
      orgId: alphaOrgId,
      email: 'alpha@piercedesk.test',
      name: 'Organization Alpha',
    },
    beta: {
      orgId: betaOrgId,
      email: 'beta@piercedesk.test',
      name: 'Organization Beta',
    },
  };
}

/**
 * Switch to a different organization
 * @param {Page} page - Playwright page
 * @param {string} orgName - Organization name to switch to
 */
export async function switchOrganization(page, orgName) {
  await page.click('[aria-label="Organization switcher"]');
  await page.click(`[role="menuitem"]:has-text("${orgName}")`);
  await page.waitForLoadState('networkidle');
}

/**
 * Verify entity count for current organization
 * @param {Page} page - Playwright page
 * @param {string} entityType - 'leads', 'opportunities', 'accounts', etc.
 * @param {number} expectedCount - Expected number of entities
 */
export async function verifyEntityCount(page, entityType, expectedCount) {
  const url = `/apps/crm/${entityType}`;
  await page.goto(url);
  await page.waitForSelector('[role="grid"]');

  const rows = await page.locator('[role="row"]:not([role="row"]:first-child)').count();
  expect(rows).toBe(expectedCount);
}

/**
 * Create a test lead for current organization
 * @param {Page} page - Playwright page
 * @param {Object} leadData - Lead details
 */
export async function createTestLead(page, leadData) {
  await page.goto('/apps/crm/leads');
  await page.click('button:has-text("Add Lead")');

  await page.fill('[name="first_name"]', leadData.first_name);
  await page.fill('[name="last_name"]', leadData.last_name);
  await page.fill('[name="company"]', leadData.company);
  await page.fill('[name="email"]', leadData.email);
  await page.selectOption('[name="source"]', leadData.source);

  await page.click('button:has-text("Create Lead")');
  await page.waitForURL(/\/apps\/crm\/leads\/lead_/);
}
```

### Step 2: Enable leads multi-tenancy tests

Remove `.skip()` from all 6 tests and update with helper functions:

**File:** `tests/crm-leads-multi-tenancy.spec.js`

Key tests to enable:
- Organization data isolation (Alpha sees only Alpha leads)
- Lead conversion creates opportunity in correct org
- Lead update isolation
- Lead delete isolation
- Bulk operations isolation
- Lead assignment within organization

### Step 3: Enable opportunities multi-tenancy tests

Remove `.skip()` from all 8 tests:

**File:** `tests/crm-opportunities-multi-tenancy.spec.js`

### Step 4: Enable proposals multi-tenancy tests

Remove `.skip()` from all 6 tests:

**File:** `tests/crm-proposals-multi-tenancy.spec.js`

### Step 5: Enable accounts/contacts multi-tenancy tests

Remove `.skip()` from all 12 tests:

**File:** `tests/crm-accounts-contacts-multi-tenancy.spec.js`

### Step 6: Run full multi-tenancy test suite

```bash
npx playwright test tests/*-multi-tenancy.spec.js
```

**Expected:** All 32 multi-tenancy tests pass with RLS enforcement verified

### Step 7: Capture multi-tenancy test evidence

```bash
npx playwright test tests/*-multi-tenancy.spec.js --reporter=html
npx playwright show-report
```

**Expected:** HTML report with all tests passing, screenshots of data isolation

### Step 8: Commit multi-tenancy tests

```bash
git add tests/*-multi-tenancy.spec.js tests/helpers/multi-tenant-setup.js
git commit -m "test(crm): enable multi-tenancy E2E tests with RLS verification

- Enable 32 multi-tenancy tests across all CRM entities
- Add multi-tenant-setup helper utilities
- Verify data isolation via RLS policies
- Test organization switching and access control
- All tests passing with Supabase integration

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

---

## Task 6: Integration Verification & Documentation

**Files:**
- Create: `_sys_documents/execution/phase1.2-integration-verification.md`
- Update: `_sys_documents/execution/phase1.2-auth-system.md`
- Update: `_sys_documents/execution/INDEX-crm-desk-mvp.md`

### Step 1: Run full test suite

```bash
npm run test:e2e
```

**Expected:** All E2E tests passing (200+ tests total)

### Step 2: Run build verification

```bash
npm run build
```

**Expected:** Build succeeds with exit code 0

### Step 3: Run lint verification

```bash
npm run lint
```

**Expected:** 0 errors, 0 warnings

### Step 4: Create integration verification document

Document all verification evidence in new file.

### Step 5: Update phase execution document

Mark Phase 1.2 as complete with 100% progress.

### Step 6: Update INDEX document

Update Phase 1.2 status to complete with all deliverables verified.

### Step 7: Remove obsolete mock data files

```bash
rm -f src/data/crm/leads.js
rm -f src/data/crm/opportunities.js
rm -f src/data/crm/proposals.js
rm -f src/data/crm/dashboard-metrics.js
```

### Step 8: Commit documentation updates

```bash
git add _sys_documents/execution/*.md
git commit -m "docs(phase1.2): complete integration verification and update INDEX

- Create comprehensive integration verification report
- Document 72 TODO markers resolved across 4 APIs
- Verify 232 E2E tests passing (200 active + 32 multi-tenancy)
- Update Phase 1.2 status to complete
- Remove obsolete mock data files

Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
```

### Step 9: Create PR for Phase 1.2

```bash
gh pr create \
  --title "feat(crm): Phase 1.2 - Complete Supabase Integration & Multi-Tenancy" \
  --body "Complete Supabase migration with RLS verification"
```

### Step 10: Verify PR created successfully

```bash
gh pr view --web
```

**Expected:** PR opens with complete details

---

## Execution Handoff

**Plan complete and saved to `docs/plans/2026-01-29-phase1.2-supabase-integration-complete.md`.**

**Two execution options:**

**1. Subagent-Driven (this session)** - Dispatch fresh subagent per task, review between tasks, fast iteration

**2. Parallel Session (separate)** - Open new session with executing-plans skill, batch execution with checkpoints

**Which approach?**
