# Phase 1.7: CRM Dashboard & Reports - Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Implement comprehensive CRM Dashboard with 18+ widgets, pipeline visualization, lead analytics, and export functionality

**Architecture:** React 19 + Material-UI v7 Grid responsive layout, ECharts visualization, SWR data fetching, React Context state management, mock data with TODO markers for Phase 1.2 Supabase integration

**Tech Stack:**
- Material-UI v7 (Grid, Paper, components)
- ECharts v6.0.0 + echarts-for-react v3.0.4
- SWR (data fetching)
- jsPDF + html2canvas (PDF export)
- xlsx (Excel export)
- date-fns (date manipulation)

---

## Overview

This plan orchestrates **6 sub-phases** implementing the CRM Dashboard & Reports feature. Each sub-phase is assigned to specialized sub-agents via the Task tool. The orchestrator (you) coordinates execution, tracks progress, updates GitHub issue #15, and ensures quality gates are met.

**GitHub Issue**: #15
**Feature Branch**: `feature/desk-crm-dashboard-phase1.7`
**INDEX**: `_sys_documents/execution/INDEX-phase1.7-crm-dashboard.md`

---

## Phase 1.7.1: Core Dashboard Infrastructure

**Assigned Agent**: `react-mui-frontend-engineer`
**Estimated Effort**: 12 hours (2 days)
**Design Doc**: `_sys_documents/design/phase1.7.1-dashboard-infrastructure.md`

### Deliverables

1. Dashboard page route: `/apps/crm/dashboard`
2. DashboardLayout.jsx (main container with responsive Grid)
3. DashboardHeader.jsx (title, date filter dropdown, menu)
4. DashboardWidgetContainer.jsx (reusable Paper wrapper for widgets)
5. CRMDashboardProvider.jsx (React Context + useReducer for state)
6. useDashboardApi.js (7 SWR hooks with mock fetchers + TODO markers)
7. dashboard-metrics.js (pre-calculated mock aggregations)
8. Routes added to paths.js and sitemap.js

### Task Execution Command

```javascript
Task(react-mui-frontend-engineer, `
Implement Phase 1.7.1 CRM Dashboard Infrastructure following design document.

Design Doc: _sys_documents/design/phase1.7.1-dashboard-infrastructure.md
INDEX: _sys_documents/execution/INDEX-phase1.7-crm-dashboard.md

Key Requirements:
1. Create dashboard route at /apps/crm/dashboard
2. Build responsive Grid layout (MUI v7 size prop pattern)
3. Create DashboardWidgetContainer reusable component
4. Implement CRMDashboardProvider with date filter state
5. Create 7 SWR hooks in useDashboardApi.js with mock fetchers
6. Add pre-calculated mock metrics to dashboard-metrics.js
7. Add routes to paths.js and sitemap.js

Search Aurora templates first for dashboard/widget patterns.
Follow TDD: Write tests before implementation.
Use existing utilities: ReactEchart, DashboardMenu, useNumberFormat.
Mark TODO comments for Supabase integration (~7-10 markers).

Verification:
- Build succeeds (exit 0)
- Lint passes (0 errors)
- Dashboard route loads with placeholder message
- Date filter dropdown works (7/30/90 days presets)
- Responsive layout verified on desktop/tablet/mobile
`);
```

### GitHub Update

After completion, post to issue #15:

```markdown
‚úÖ **Phase 1.7.1 Complete: Dashboard Infrastructure**

**Components Created:**
- Dashboard route: `/apps/crm/dashboard`
- DashboardLayout, DashboardHeader, DashboardWidgetContainer
- CRMDashboardProvider (state management)
- useDashboardApi.js (7 SWR hooks)
- dashboard-metrics.js (mock data)

**Verification:**
- Build: ‚úÖ Exit 0
- Lint: ‚úÖ 0 errors
- Responsive: ‚úÖ Desktop/Tablet/Mobile tested
- TODO markers: 7 documented for Phase 1.2

**Next**: Phase 1.7.2 - KPI Metrics Widgets
```

---

## Phase 1.7.2: KPI Metrics Widgets

**Assigned Agent**: `react-mui-frontend-engineer`
**Estimated Effort**: 10 hours (1.5 days)
**Execution Doc**: `_sys_documents/execution/phase1.7.2-kpi-widgets.md`

### Deliverables (8 KPI Widgets)

1. TotalPipelineValueWidget.jsx
2. WeightedForecastWidget.jsx
3. LeadConversionRateWidget.jsx
4. OpportunityWinRateWidget.jsx
5. AverageDealSizeWidget.jsx
6. AverageSalesCycleWidget.jsx
7. ProposalsAcceptanceRateWidget.jsx
8. TotalActiveAccountsWidget.jsx

Each widget: Avatar icon, title, large value (h5), optional subtitle, trend indicator (optional)

### Task Execution Command

```javascript
Task(react-mui-frontend-engineer, `
Implement Phase 1.7.2 KPI Metrics Widgets (8 widgets).

Requirements:
1. Create 8 KPI widget components using DashboardWidgetContainer
2. Use useDashboardKPIs() hook from Phase 1.7.1
3. Format values: formatCurrency(), formatNumber(), formatPercentage()
4. Icons from material-symbols collection
5. Grid size: {{ xs: 12, sm: 6, md: 3 }} (4 columns on desktop)
6. Add widgets to DashboardLayout.jsx

Widget List:
- TotalPipelineValue (icon: trending-up, currency format)
- WeightedForecast (icon: calculate, currency format)
- LeadConversionRate (icon: conversion, percentage format)
- OpportunityWinRate (icon: emoji-events, percentage format)
- AverageDealSize (icon: payments, currency format)
- AverageSalesCycle (icon: schedule, days format)
- ProposalsAcceptanceRate (icon: task-alt, percentage format)
- TotalActiveAccounts (icon: business, number format)

Follow TDD: Write tests for each widget before implementation.
Use existing KPI.jsx pattern from src/components/sections/dashboards/crm/kpi/.

Verification:
- All 8 widgets render with mock data
- Formatting functions applied correctly
- Responsive grid works (4 cols ‚Üí 2 cols ‚Üí 1 col)
- Build succeeds, lint passes
`);
```

### GitHub Update

```markdown
‚úÖ **Phase 1.7.2 Complete: KPI Metrics Widgets**

**8 Widgets Delivered:**
- Total Pipeline Value, Weighted Forecast
- Lead Conversion Rate, Opportunity Win Rate
- Average Deal Size, Average Sales Cycle
- Proposals Acceptance Rate, Total Active Accounts

**Verification:**
- Build: ‚úÖ Exit 0
- Lint: ‚úÖ 0 errors
- Responsive: ‚úÖ 4‚Üí2‚Üí1 column layout works
- Screenshots: [Attach dashboard screenshot]

**Next**: Phase 1.7.3 - Pipeline Visualization Widgets
```

---

## Phase 1.7.3: Pipeline Visualization Widgets

**Assigned Agent**: `react-mui-frontend-engineer`
**Estimated Effort**: 12 hours (1.5 days)
**Execution Doc**: `_sys_documents/execution/phase1.7.3-pipeline-widgets.md`

### Deliverables (4 Chart Widgets)

1. PipelineStageBreakdownWidget.jsx (Horizontal bar chart)
2. OpportunityTrendWidget.jsx (Line chart - created vs. closed over time)
3. PipelineVelocityWidget.jsx (Bar chart - avg days per stage)
4. ForecastAccuracyWidget.jsx (Comparison chart - forecast vs. actual)

### Task Execution Command

```javascript
Task(react-mui-frontend-engineer, `
Implement Phase 1.7.3 Pipeline Visualization Widgets (4 chart widgets).

Requirements:
1. Use ReactEchart.jsx base component (already exists)
2. Use ECharts BarChart and LineChart modules
3. Implement useToggleChartLegends hook for series visibility
4. Use tooltipFormatterList from echart-utils.js
5. Use getThemeColor() for chart colors
6. Grid size: {{ xs: 12, md: 6 }} (2 columns on desktop)

Widget Details:
1. PipelineStageBreakdown
   - Horizontal bar chart showing value per stage
   - Use usePipelineBreakdown() hook
   - Colors: stage-specific (qualification=info, proposal=primary, etc.)

2. OpportunityTrend
   - Line chart: Created (blue), Closed Won (green), Closed Lost (red)
   - Use useOpportunityTrend() hook
   - X-axis: dates, Y-axis: count

3. PipelineVelocity
   - Vertical bar chart: Avg days in each stage
   - Use usePipelineBreakdown() with velocity calculation
   - Color gradient: faster stages (green) to slower (red)

4. ForecastAccuracy
   - Line chart comparing weighted forecast vs. actual closed
   - Mock data: Historical 6 months
   - Shows forecast prediction accuracy

Follow existing StageBreakdownChart.jsx pattern from Phase 1.5.
Follow TDD: Write tests before implementation.

Verification:
- All charts render with mock data
- Interactive tooltips work
- Legend toggles hide/show series
- Responsive: Charts resize correctly on mobile
- Build succeeds, lint passes
`);
```

### GitHub Update

```markdown
‚úÖ **Phase 1.7.3 Complete: Pipeline Visualization Widgets**

**4 Chart Widgets Delivered:**
- Pipeline Stage Breakdown (horizontal bar)
- Opportunity Trend (line chart - created vs. closed)
- Pipeline Velocity (bar chart - days per stage)
- Forecast Accuracy (forecast vs. actual comparison)

**Verification:**
- Build: ‚úÖ Exit 0
- Lint: ‚úÖ 0 errors
- Charts: ‚úÖ Interactive tooltips, legend toggles work
- Screenshots: [Attach chart screenshots]

**Next**: Phase 1.7.4 - Lead & Source Analytics Widgets
```

---

## Phase 1.7.4: Lead & Source Analytics Widgets

**Assigned Agent**: `react-mui-frontend-engineer`
**Estimated Effort**: 10 hours (1.5 days)
**Execution Doc**: `_sys_documents/execution/phase1.7.4-lead-analytics.md`

### Deliverables (3 Widgets)

1. LeadSourcePerformanceWidget.jsx (Pie chart + conversion table)
2. LeadFunnelVisualizationWidget.jsx (Funnel chart)
3. TopPerformingAccountsWidget.jsx (DataGrid table)

### Task Execution Command

```javascript
Task(react-mui-frontend-engineer, `
Implement Phase 1.7.4 Lead & Source Analytics Widgets (3 widgets).

Requirements:
1. Use ReactEchart for pie/funnel charts
2. Use Material-UI DataGrid for tables
3. Grid sizes vary by widget type

Widget Details:
1. LeadSourcePerformance
   - Pie chart: Lead count by source
   - Table below: Source, Count, Converted, Conversion %
   - Use useLeadSourcePerformance() hook
   - Grid size: {{ xs: 12, md: 6 }}

2. LeadFunnelVisualization
   - Funnel chart: New ‚Üí Contacted ‚Üí Qualified ‚Üí Converted
   - Show count and % at each stage
   - Use mock leadFunnel data
   - Grid size: {{ xs: 12, md: 6 }}

3. TopPerformingAccounts
   - DataGrid: Account Name, Opportunities, Total Value
   - Sorted by Total Value DESC
   - Click row ‚Üí navigate to account detail
   - Use useTopAccounts() hook
   - Grid size: {{ xs: 12 }}

Follow existing lead sources pie chart pattern from CRM dashboard section.
Follow TDD: Write tests before implementation.

Verification:
- All 3 widgets render with mock data
- Pie chart interactive (hover shows percentages)
- Funnel shows conversion rates between stages
- Table sortable and navigable
- Build succeeds, lint passes
`);
```

### GitHub Update

```markdown
‚úÖ **Phase 1.7.4 Complete: Lead & Source Analytics Widgets**

**3 Widgets Delivered:**
- Lead Source Performance (pie chart + conversion table)
- Lead Funnel Visualization (funnel chart)
- Top Performing Accounts (sortable DataGrid)

**Verification:**
- Build: ‚úÖ Exit 0
- Lint: ‚úÖ 0 errors
- Charts: ‚úÖ Interactive, navigation works
- Screenshots: [Attach screenshots]

**Next**: Phase 1.7.5 - Activity & Proposal Widgets
```

---

## Phase 1.7.5: Activity & Proposal Widgets

**Assigned Agent**: `react-mui-frontend-engineer`
**Estimated Effort**: 8 hours (1 day)
**Execution Doc**: `_sys_documents/execution/phase1.7.5-activity-proposal-widgets.md`

### Deliverables (3 Widgets)

1. RecentActivitiesWidget.jsx (Timeline list)
2. ProposalStatusBreakdownWidget.jsx (Donut chart)
3. TopOpportunitiesWidget.jsx (DataGrid table)

### Task Execution Command

```javascript
Task(react-mui-frontend-engineer, `
Implement Phase 1.7.5 Activity & Proposal Widgets (3 widgets).

Requirements:
1. Timeline component for activities
2. Donut chart for proposal status
3. DataGrid for top opportunities

Widget Details:
1. RecentActivities
   - Timeline (MUI Timeline component)
   - Show last 20 activities across all CRM entities
   - Icon per activity type (note, email, call, meeting)
   - Click activity ‚Üí navigate to entity detail
   - Use useRecentActivities() hook
   - Grid size: {{ xs: 12, md: 6 }}

2. ProposalStatusBreakdown
   - Donut chart: Proposals by status (draft, sent, accepted, rejected, expired)
   - Center text: Total proposal count
   - Use useProposalStatusBreakdown() hook
   - Grid size: {{ xs: 12, md: 6 }}

3. TopOpportunities
   - DataGrid: Opportunity Name, Account, Value, Stage, Probability, Close Date
   - Sorted by Value DESC (top 10)
   - Click row ‚Üí navigate to opportunity detail
   - Use useTopOpportunities() hook
   - Grid size: {{ xs: 12 }}

Follow TDD: Write tests before implementation.

Verification:
- All 3 widgets render with mock data
- Timeline clickable and navigable
- Donut chart shows percentages
- Table sortable and navigable
- Build succeeds, lint passes
`);
```

### GitHub Update

```markdown
‚úÖ **Phase 1.7.5 Complete: Activity & Proposal Widgets**

**3 Widgets Delivered:**
- Recent Activities (timeline with last 20 activities)
- Proposal Status Breakdown (donut chart)
- Top Opportunities (sortable DataGrid)

**All 18 Dashboard Widgets Complete! üéâ**

**Verification:**
- Build: ‚úÖ Exit 0
- Lint: ‚úÖ 0 errors
- Navigation: ‚úÖ All clickable elements work
- Screenshots: [Attach full dashboard screenshot]

**Next**: Phase 1.7.6 - Export Functionality & Testing
```

---

## Phase 1.7.6: Export Functionality & Testing

**Assigned Agents**: `react-mui-frontend-engineer` + `playwright-tester`
**Estimated Effort**: 14 hours (2 days)
**Execution Doc**: `_sys_documents/execution/phase1.7.6-reports-testing.md`

### Deliverables

1. Export dashboard to PDF (jsPDF + html2canvas)
2. Export tables to CSV (Blob API)
3. Export tables to Excel (xlsx library)
4. Widget visibility toggle (show/hide individual widgets)
5. 40+ E2E tests (35 active, 5 multi-tenancy pending Phase 1.2)

### Task 1: Export Functionality

```javascript
Task(react-mui-frontend-engineer, `
Implement Phase 1.7.6 Export Functionality.

Requirements:
1. Install dependencies: jspdf, html2canvas, xlsx
2. Create dashboardExports.js utility with 3 functions
3. Add export buttons to DashboardMenu dropdown

Export Functions:
1. exportDashboardToPDF()
   - Capture entire dashboard as high-res image
   - Use html2canvas to render dashboard
   - Use jsPDF to create PDF with image
   - Filename: "CRM-Dashboard-YYYY-MM-DD.pdf"
   - Handle multi-page if dashboard > A4 height

2. exportTableToCSV(data, headers, filename)
   - Convert array of objects to CSV string
   - Use Blob API to trigger download
   - Filename: "{tableName}-YYYY-MM-DD.csv"

3. exportTableToExcel(sheets, filename)
   - Multi-sheet workbook with xlsx library
   - sheets: [{ name, data, headers }]
   - Apply column formatting (currency, percentage)
   - Filename: "CRM-Report-YYYY-MM-DD.xlsx"

DashboardMenu Updates:
- Add "Export to PDF" menu item
- Add "Export Data to Excel" menu item (all tables)
- Add "Widget Settings" menu item (toggle visibility)

Widget Visibility Toggle:
- Modal dialog with checkboxes for each widget
- Use CRMDashboardProvider toggleWidgetVisibility action
- Persist to localStorage (future enhancement)

Follow TDD: Write tests for export functions.

Verification:
- PDF export generates readable file
- CSV export downloads correct data
- Excel export creates valid workbook
- Widget visibility toggle works
- Build succeeds, lint passes
`);
```

### Task 2: E2E Testing

```javascript
Task(playwright-tester, `
Create Phase 1.7.6 E2E Tests for CRM Dashboard.

Test Coverage (40 tests):

**Dashboard Navigation (5 tests)**
- Navigate to /apps/crm/dashboard
- Verify page title "CRM Dashboard"
- Verify 18 widgets render
- Verify responsive layout (desktop/tablet/mobile)
- Verify loading states on initial render

**Date Filter Tests (6 tests)**
- Select "Last 7 Days" preset
- Select "Last 30 Days" preset
- Select "Last 90 Days" preset
- Verify widgets re-fetch data on filter change
- Verify loading states during re-fetch
- Verify date range displays correctly in header

**KPI Widget Tests (8 tests)**
- Verify TotalPipelineValue displays formatted currency
- Verify WeightedForecast calculates correctly
- Verify LeadConversionRate shows percentage
- Verify OpportunityWinRate shows percentage
- Verify AverageDealSize formatted currency
- Verify AverageSalesCycle shows days
- Verify ProposalsAcceptanceRate percentage
- Verify TotalActiveAccounts number

**Chart Interaction Tests (6 tests)**
- Click PipelineStageBreakdown bar ‚Üí no errors
- Toggle chart legend ‚Üí series hides/shows
- Hover OpportunityTrend ‚Üí tooltip displays
- Hover LeadSourcePerformance pie ‚Üí tooltip shows percentage
- Verify charts responsive on mobile
- Verify charts render without errors

**Navigation Tests (4 tests)**
- Click TopAccounts row ‚Üí navigates to account detail
- Click TopOpportunities row ‚Üí navigates to opportunity detail
- Click RecentActivities item ‚Üí navigates to entity detail
- Verify back button returns to dashboard

**Export Tests (6 tests)**
- Click "Export to PDF" ‚Üí downloads PDF file
- Verify PDF filename format "CRM-Dashboard-YYYY-MM-DD.pdf"
- Click "Export Data to Excel" ‚Üí downloads Excel file
- Verify Excel filename format "CRM-Report-YYYY-MM-DD.xlsx"
- Open Excel file ‚Üí verify multiple sheets
- Verify CSV export (TopAccounts table)

**Multi-Tenancy Tests (5 tests - .skip() pending Phase 1.2)**
- Verify dashboard filters by organization_id
- Switch organization ‚Üí dashboard data updates
- Verify no data leakage between organizations
- Verify RLS policies enforced (after Phase 1.2)
- Verify multi-user concurrent access

Test Files:
- tests/e2e/crm-dashboard.spec.js (35 active tests)
- tests/e2e/crm-dashboard-multi-tenancy.spec.js (5 skipped tests)

Mark multi-tenancy tests with .skip() and TODO comments.

Verification:
- 35 active tests pass (0 failures)
- 5 multi-tenancy tests marked .skip()
- Test output captured with screenshots
- Build verification: exit 0
`);
```

### GitHub Update

```markdown
‚úÖ **Phase 1.7.6 Complete: Export & Testing**

**Export Features:**
- ‚úÖ PDF export (full dashboard capture)
- ‚úÖ CSV export (table data)
- ‚úÖ Excel export (multi-sheet workbook)
- ‚úÖ Widget visibility toggle

**Test Results:**
- ‚úÖ 35 E2E tests passing (0 failures)
- ‚è≥ 5 multi-tenancy tests marked .skip() (pending Phase 1.2)
- ‚úÖ Build: Exit 0
- ‚úÖ Lint: 0 errors

**Phase 1.7 COMPLETE! üéâ**

**Summary:**
- 18 widgets delivered (8 KPIs, 4 pipeline viz, 3 lead analytics, 3 activities)
- 3 export formats (PDF, CSV, Excel)
- 40 E2E tests
- ~25 TODO markers for Phase 1.2 Supabase integration
- Dashboard route live at `/apps/crm/dashboard`

**Screenshots**: [Attach full dashboard screenshots: desktop, tablet, mobile]
**Test Evidence**: [Attach Playwright report]

**Next**: Phase 1.8 - Final Testing & Polish (CRM MVP completion)
```

---

## Orchestration Workflow

### Orchestrator Responsibilities

1. **Invoke Skills Before Each Phase**
   - `/TDD` before implementation phases
   - `/VERIFY-BEFORE-COMPLETE` before marking phases complete
   - `/software-architecture` for design validation

2. **Launch Sub-Agents via Task Tool**
   - Use Task(react-mui-frontend-engineer, ...) for UI phases
   - Use Task(playwright-tester, ...) for testing
   - Provide clear requirements and verification criteria

3. **Track Progress in INDEX**
   - Update phase status after each completion
   - Mark todos complete in TodoWrite
   - Capture verification evidence

4. **GitHub Issue Updates**
   - Post progress comments to issue #15 after each phase
   - Include verification evidence (build output, screenshots)
   - Tag blockers if encountered

5. **Quality Gates**
   - Verify build succeeds (exit 0) after each phase
   - Verify lint passes (0 errors)
   - Review code before moving to next phase

### Phase Sequence

1. **Phase 1.7.1** ‚Üí Infrastructure foundation
2. **Phase 1.7.2** ‚Üí KPI widgets (depends on 1.7.1)
3. **Phase 1.7.3** ‚Üí Pipeline charts (depends on 1.7.1)
4. **Phase 1.7.4** ‚Üí Lead analytics (depends on 1.7.1)
5. **Phase 1.7.5** ‚Üí Activity/proposal widgets (depends on 1.7.1)
6. **Phase 1.7.6** ‚Üí Export & testing (depends on 1.7.2-1.7.5)

Phases 1.7.2-1.7.5 can run in PARALLEL after 1.7.1 completes (independent widgets).

### Final Steps

After Phase 1.7.6 complete:

1. **Run Full Verification**
   ```bash
   npm run build && npm run lint && npm run test:e2e
   ```

2. **Invoke /VERIFY-BEFORE-COMPLETE**
   - Capture all command outputs
   - Take screenshots of dashboard (desktop/mobile)
   - Generate test report

3. **Commit All Changes**
   ```bash
   git add .
   git commit -m "Complete Phase 1.7: CRM Dashboard & Reports

   - 18 widgets: KPIs, pipeline viz, lead analytics, activities
   - Export: PDF, CSV, Excel
   - 40 E2E tests (35 passing, 5 pending Phase 1.2)
   - TODO markers: 25 for Supabase integration

   Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>"
   ```

4. **Push to Remote**
   ```bash
   git push -u origin feature/desk-crm-dashboard-phase1.7
   ```

5. **Create Pull Request**
   - Use `gh pr create` with comprehensive description
   - Link to INDEX, design docs, GitHub issue #15
   - Include verification evidence and screenshots

6. **Update Parent INDEX**
   - Mark Phase 1.7 complete in `INDEX-crm-desk-mvp.md`
   - Update progress percentage
   - Note next steps (Phase 1.8)

---

## Execution Handoff

**Plan complete and saved to `docs/plans/2026-01-29-phase1.7-crm-dashboard.md`.**

**Two execution options:**

**1. Subagent-Driven (this session)** - Orchestrator dispatches fresh subagent per phase, reviews between phases, fast iteration

**2. Parallel Session (separate)** - Open new session with executing-plans skill, batch execution with checkpoints

**Which approach do you prefer?**

If **Subagent-Driven** chosen:
- **REQUIRED SUB-SKILL:** Use superpowers:subagent-driven-development
- Stay in this session
- Fresh subagent per phase + code review

If **Parallel Session** chosen:
- Guide user to open new session in worktree
- **REQUIRED SUB-SKILL:** New session uses superpowers:executing-plans

---

**Status**: ‚è≥ Plan Complete - Ready for Execution
**Next Action**: Choose execution approach and begin Phase 1.7.1
**Owner**: Pierce Team + Claude Code Orchestrator
**Last Updated**: 2026-01-29
