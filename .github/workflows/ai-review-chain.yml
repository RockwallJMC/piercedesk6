name: ai-review-chain

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: read

concurrency:
  group: ai-review-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  wait_for_q_check:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Wait for Amazon Q check
        run: node scripts/ai-review/wait-for-check.mjs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CHECK_NAME: ${{ vars.Q_CHECK_NAME || 'Amazon Q Developer' }}
          TIMEOUT_MINUTES: ${{ vars.REVIEW_WAIT_TIMEOUT_MINUTES || '30' }}
          POLL_INTERVAL_SECONDS: ${{ vars.REVIEW_POLL_INTERVAL_SECONDS || '20' }}

  wait_for_optional_reviews:
    needs: wait_for_q_check
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Wait for comment-based reviews (optional)
        run: node scripts/ai-review/wait-for-reviews.mjs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REVIEWER_LOGINS: ${{ vars.OPTIONAL_REVIEWERS || '' }}
          TIMEOUT_MINUTES: ${{ vars.REVIEW_WAIT_TIMEOUT_MINUTES || '30' }}
          POLL_INTERVAL_SECONDS: ${{ vars.REVIEW_POLL_INTERVAL_SECONDS || '20' }}

  approve_merge:
    needs: [wait_for_q_check, wait_for_optional_reviews]
    if: ${{ secrets.AUTO_MERGE_ENABLED == 'true' && needs.wait_for_q_check.result == 'success' && needs.wait_for_optional_reviews.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Approve and merge
        run: node scripts/ai-review/approve-merge.mjs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MERGE_METHOD: ${{ secrets.MERGE_METHOD }}
